#!/usr/bin/env ruby

require 'balboa_worldwide_app/client'

def watch(spa)
  loop do
    begin
      status = spa.poll
      puts status.raw_data.unpack("H*").first.scan(/[0-9a-f]{2}/).join(' ')
      puts status.inspect
    rescue BalboaWorldwideApp::InvalidMessage => e
      puts e.message
      puts e.raw_data.unpack("H*").first.scan(/[0-9a-f]{2}/).join(' ')
      break
    end
  end
end

if ARGV.empty?
  spas = BalboaWorldwideApp::Client.discover
  if spas.empty?
    $stderr.puts "Could not find spa!"
    exit 1
  end
  spa_ip = spas.first.first
else
  spa_ip = ARGV[0]
end

spa = BalboaWorldwideApp::Client.new(spa_ip)

spa.request_configuration
spa.poll until spa.last_status

watch(spa)
